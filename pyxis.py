import requests
import pprint




def main():
    pyxis = "https://catalog.redhat.com/api/containers/v1"
    hydra = "https://access.redhat.com/hydra/rest/securitydata"

    image_registry = "registry.access.redhat.com"
    image_repo = "ubi8"
    container_image = f"{pyxis}/repositories/registry/{image_registry}/repository/{image_repo}/images"

 

    count = 0
    imagedata = []
    page = 0
    while True:
        r = requests.get(f"{container_image}?page={page}").json()
        imagedata += r["data"]
        count += len(r["data"])
        if count == r["total"]:
            break
        page +=1


    data = []
    for image in imagedata: 
        image_advisory_id = []
        image_tags = []
        content_advisory_ids = []
        for repository in image["repositories"]:
            image_advisory_id.append(repository["image_advisory_id"])
            if "content_advisory_ids" in repository.keys():
                content_advisory_ids += repository["content_advisory_ids"]
            for tags in repository["tags"]:
                if tags["name"] == "latest":
                    continue
                image_tags.append(tags["name"])

        this_image = {
            "image": f"""{image_registry}/{image_repo}""",
            "tag": max(set(image_tags), key=len),
            "image_advisory": set(image_advisory_id),
            "content_advisory": set(content_advisory_ids),
            "fixed_cves": []
        }

        for rhsa in this_image["content_advisory"]:
            if "RHSA" not in rhsa:
                continue
            r = requests.get(f"{hydra}/csaf/{rhsa}.json").json()
            if "vulnerabilities" in r.keys():
                for vuln in r["vulnerabilities"]:
                    this_image["fixed_cves"].append(vuln["cve"])

    pprint.pprint(data)

if __name__ == "__main__":
    main()
